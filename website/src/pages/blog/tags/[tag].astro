---
import Layout from "@/components/layout/Layout.astro";
import Card from "@/components/features/blog/Card.astro";
import { getCollection } from "astro:content";
import { DEFAULT_LOCALE, getLocalizedPath } from "@/utils/i18n";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog", ({ id }) => {
    return id.toLowerCase().startsWith(`${DEFAULT_LOCALE.toLowerCase()}/`);
  });

  const uniqueTags = [...new Set(allPosts.flatMap((post) => post.data.tags))];

  return uniqueTags.map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;

const posts = await getCollection("blog", ({ id, data }) => {
  return (
    id.toLowerCase().startsWith(`${DEFAULT_LOCALE.toLowerCase()}/`) &&
    data.tags.includes(tag)
  );
});

const sortedPosts = posts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
---

<Layout title={`Blog - ${tag}`} description={`Posts tagged with ${tag}`}>
  <div class="container mx-auto px-4 py-12">
    <div class="mb-8">
      <h1 class="mb-2 text-4xl font-bold text-white">Blog</h1>
      <p class="text-xl text-gray-300">
        Posts tagged with <span class="text-primary font-semibold">#{tag}</span>
      </p>
      <a
        href={getLocalizedPath(DEFAULT_LOCALE, "/blog")}
        class="mt-4 inline-block text-sm text-gray-400 hover:text-white"
      >
        ‚Üê Back to all posts
      </a>
    </div>

    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {
        sortedPosts.map((post) => (
          <Card
            title={post.data.title}
            description={post.data.description}
            pubDate={post.data.pubDate}
            href={getLocalizedPath(
              DEFAULT_LOCALE,
              `/blog/${post.id.split("/").slice(1).join("/")}`,
            )}
            tags={post.data.tags}
            heroImage={post.data.heroImage}
          />
        ))
      }
      {
        sortedPosts.length === 0 && (
          <p class="col-span-full text-center text-gray-400">
            No posts found with this tag.
          </p>
        )
      }
    </div>
  </div>
</Layout>
