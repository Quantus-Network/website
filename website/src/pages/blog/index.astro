---
import Layout from "@/components/layout/Layout.astro";
import { BlogSearch } from "@/components/features/blog/Search";
import { getCollection } from "astro:content";
import {
  DEFAULT_LOCALE,
  getLocalizedPath,
  createTranslator,
} from "@/utils/i18n";

const t = await createTranslator(DEFAULT_LOCALE);

const posts = await getCollection("blog", ({ id }) => {
  return id.toLowerCase().startsWith(`${DEFAULT_LOCALE.toLowerCase()}/`);
});

const sortedPosts = posts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Map posts to a simple serializable format for the React component
const serializablePosts = sortedPosts.map((post) => ({
  id: post.id,
  slug: post.id.split("/").slice(1).join("/"),
  data: {
    title: post.data.title,
    description: post.data.description,
    pubDate: post.data.pubDate.toISOString(),
    tags: post.data.tags,
    heroImage: post.data.heroImage,
  },
}));

const metadata = {
  title: t("blog.meta.title"),
  description: t("blog.meta.description"),
};
---

<Layout {...metadata}>
  <div class="container mx-auto px-4 py-12">
    <h1 class="mb-8 text-4xl font-bold text-white">{t("blog.title")}</h1>

    <BlogSearch
      client:load
      posts={serializablePosts}
      locale={DEFAULT_LOCALE}
      localizedBlogPath={getLocalizedPath(DEFAULT_LOCALE, "/blog")}
      localizedTagPath={getLocalizedPath(DEFAULT_LOCALE, "/blog/tags")}
      searchPlaceholder={t("navbar.search_placeholder")}
      noPostsFoundText={t("navbar.no_posts_found")}
    />
  </div>
</Layout>
