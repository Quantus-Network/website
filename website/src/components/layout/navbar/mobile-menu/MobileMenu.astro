---
import Button from "@/components/ui/Button.astro";
import SiteSocials from "@/components/ui/SiteSocials.astro";
import SphereDecoration from "@/components/ui/SphereDecoration.astro";
import { applyStyles } from "@/utils/apply-styles";
import {
  createTranslator,
  getLocaleFromUrl,
  getLocalizedPath,
} from "@/utils/i18n";
import { SITE_NAVIGATIONS } from "@/constants/site-navigations";
import { ChevronDownIcon } from "@lucide/astro";

const locale = getLocaleFromUrl(Astro.url.pathname);
const t = await createTranslator(locale);
---

<div
  class="mobile-menu bg-navbar-mobile-menu navbar-desktop:hidden absolute top-[139px] left-0 z-10 hidden h-[calc(100vh-64px-64px)] w-full flex-col items-center overflow-hidden px-9 py-[62px] transition-opacity"
  id="mobile-menu"
>
  <SphereDecoration
    class="absolute -top-[0.8rem] -right-[5rem] -z-10"
    variant="1"
    size={202}
  />
  <SphereDecoration
    class="absolute top-[5.5rem] -z-10"
    variant="2"
    size={320}
  />
  <SphereDecoration
    class="absolute -bottom-[3rem] -left-[6rem] -z-10"
    variant="3"
    size={283}
  />
  <div id="mobile-nav-links" class="flex w-full flex-col gap-4">
    {
      SITE_NAVIGATIONS.map((item, index) => {
        if ("children" in item) {
          const mobileGroupId = `mobile-group-${index}`;
          return (
            <div class="flex flex-col gap-4">
              <button
                type="button"
                aria-expanded="false"
                aria-controls={mobileGroupId}
                class="mobile-group-toggle text-navbar-link font-large-body flex w-full items-center justify-between transition-colors duration-200 hover:font-bold"
              >
                {t(item.label)}
                <ChevronDownIcon class="size-5 transition-transform" />
              </button>
              <div
                id={mobileGroupId}
                class="mobile-group-children hidden flex-col gap-4 pl-4"
              >
                {item.children.map((child) => (
                  <a
                    href={getLocalizedPath(locale, child.href)}
                    class={applyStyles(
                      "text-navbar-link font-large-body block transition-colors duration-200 hover:font-bold",
                      child.isSpecial &&
                        "aria-[current='page']:text-quantus-yellow",
                    )}
                  >
                    {t(child.label)}
                  </a>
                ))}
              </div>
            </div>
          );
        }

        return (
          <a
            href={getLocalizedPath(locale, item.href)}
            class={applyStyles(
              "text-navbar-link font-large-body block transition-colors duration-200 hover:font-bold",
              item.isSpecial && "aria-[current='page']:text-quantus-yellow",
            )}
          >
            {t(item.label)}
          </a>
        );
      })
    }
  </div>

  <SiteSocials class="mt-8 justify-center" />

  <Button href="/app" target="_self" class="mt-8">{t("navbar.cta")}</Button>
</div>

<style>
  /* Ensure smooth transitions */
  .mobile-menu {
    transition:
      opacity 0.2s ease-in-out,
      transform 0.2s ease-in-out;
  }
</style>

<script>
  import { getLocaleFromUrl, getLocalizedPath } from "@/utils/i18n";
  const locale = getLocaleFromUrl(location.pathname);

  const mobileMenuButton = document.querySelector<HTMLDivElement>(
    "#mobile-menu-button",
  );
  const mobileMenu = document.querySelector(".mobile-menu");
  const menuIcon = document.querySelector(".menu-icon");
  const closeIcon = document.querySelector(".close-icon");
  const mobileNavLinks = document.getElementById("mobile-nav-links");
  const links = mobileNavLinks?.querySelectorAll("a");
  const groupToggles =
    mobileNavLinks?.querySelectorAll<HTMLButtonElement>(".mobile-group-toggle");

  const updateLinkStatus = (link: HTMLAnchorElement, isActive: boolean) => {
    if (isActive) {
      link.classList.add("font-bold");
      link.setAttribute("aria-current", "page");

      // If it's a child link, expand the parent group and highlight it
      const groupContainer = link.closest(".flex.flex-col.gap-4");
      if (groupContainer) {
        const children = groupContainer.querySelector<HTMLElement>(
          ".mobile-group-children",
        );
        const toggle = groupContainer.querySelector<HTMLButtonElement>(
          ".mobile-group-toggle",
        );
        const icon = toggle?.querySelector("svg");

        if (children && children.classList.contains("hidden")) {
          children.classList.remove("hidden");
          children.classList.add("flex");
          icon?.classList.add("rotate-180");
          toggle?.setAttribute("aria-expanded", "true");
        }
        toggle?.classList.add("font-bold");
      }
    } else {
      link.classList.remove("font-bold");
      link.removeAttribute("aria-current");
    }
  };

  const checkIsActive = (link: HTMLAnchorElement) => {
    const linkPath = new URL(link.href).pathname + new URL(link.href).hash;
    const currentPath = location.pathname + location.hash;
    return currentPath === getLocalizedPath(locale, linkPath);
  };

  // Handle group toggles
  groupToggles?.forEach((toggle) => {
    toggle.addEventListener("click", () => {
      const children = toggle.nextElementSibling as HTMLElement;
      const icon = toggle.querySelector("svg");

      if (children) {
        const isHidden = children.classList.contains("hidden");
        children.classList.toggle("hidden", !isHidden);
        children.classList.toggle("flex", isHidden);
        icon?.classList.toggle("rotate-180", isHidden);
        toggle.setAttribute("aria-expanded", isHidden.toString());
      }
    });
  });

  links?.forEach((link) => {
    updateLinkStatus(link, checkIsActive(link));

    link.addEventListener("click", () => {
      mobileMenu?.classList.add("hidden");
      mobileMenu?.classList.remove("flex");

      menuIcon?.classList.remove("hidden");
      closeIcon?.classList.add("hidden");
      mobileMenuButton?.setAttribute("aria-expanded", "false");

      setTimeout(() => {
        links.forEach((val) => {
          updateLinkStatus(val, checkIsActive(val));
        });
      }, 0);
    });
  });

  window.addEventListener("hashchange", () => {
    links?.forEach((link) => {
      updateLinkStatus(link, checkIsActive(link));
    });
  });
</script>
