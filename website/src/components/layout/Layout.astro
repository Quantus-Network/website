---
import "../../styles/global.css";
import "@fontsource/prompt/200.css";
import "@fontsource/prompt/300.css";
import "@fontsource/prompt/400.css";
import "@fontsource/prompt/600.css";
import "@fontsource/prompt/700.css";
import "@fontsource/prompt/900.css";
import "@fontsource/inter/900.css";

import Navbar from "./navbar/Navbar.astro";
import Footer from "./footer/Footer.astro";

import { SEO, type SEOProps } from "astro-seo";
import type { WithContext, Graph, Thing } from "schema-dts";
import { getLocaleFromUrl, getTextDirection } from "@/utils/i18n";
import CookieConsent from "@/components/ui/CookieConsent.astro";
import Toast from "../ui/Toast.astro";

interface Props extends SEOProps {
  jsonLd?: WithContext<Thing> | Graph;
}

const { jsonLd, ...metadata } = Astro.props;

const currentLocale = getLocaleFromUrl(Astro.url.pathname);
const textDirection = getTextDirection(currentLocale);
---

<!doctype html>
<html lang={currentLocale} dir={textDirection} class="flex min-h-full flex-col">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <meta name="generator" content={Astro.generator} />
    <SEO {...metadata} titleTemplate={undefined} />
  </head>
  <body class="flex grow flex-col pt-[139px]" data-locale={currentLocale}>
    {
      jsonLd && (
        <script
          type="application/ld+json"
          set:html={JSON.stringify(jsonLd).replace(/</g, "\\u003c")}
          is:inline
        />
      )
    }

    <Navbar locale={currentLocale} />
    <main class="grow">
      <slot />
    </main>
    <Footer />

    <CookieConsent />
    <Toast />
  </body>
</html>

<script>
  import {
    DEFAULT_LOCALE,
    getLocaleFromUrl,
    SUPPORTED_LOCALES,
  } from "@/utils/i18n";

  const localeStorageKey = "astro-i18n-redirect";
  const hasRedirected = localStorage.getItem(localeStorageKey);

  if (hasRedirected) throw new Error("Already redirected");

  const currentLocale = getLocaleFromUrl(window.location.pathname);
  const userLang = navigator.language as any;

  if (currentLocale === userLang || userLang.includes("en-")) {
    localStorage.setItem(localeStorageKey, "true");
    throw new Error("Already on the correct locale");
  }

  const cleanPathname = window.location.pathname
    .split("/")
    .filter((path: any) => !SUPPORTED_LOCALES.includes(path) && path !== "")
    .join("/");

  let newPath = `/${cleanPathname}`;

  if (SUPPORTED_LOCALES.includes(userLang) && userLang !== DEFAULT_LOCALE) {
    newPath = `/${userLang}${cleanPathname}`;
  }

  if (window.location.search) {
    newPath += window.location.search;
  }

  localStorage.setItem(localeStorageKey, "true");
  window.location.replace(newPath);
</script>
