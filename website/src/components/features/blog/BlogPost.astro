---
import Layout from "@/components/layout/Layout.astro";
import Tag from "@/components/ui/Tag.astro";
import Card from "@/components/features/blog/Card.astro";
import type { CollectionEntry } from "astro:content";
import type { Article, WithContext } from "schema-dts";
import {
  getLocaleFromUrl,
  getLocalizedPath,
  createTranslator,
} from "@/utils/i18n";
import env from "@/config";
import { createMetadata } from "@/utils/create-metadata";

type Props = CollectionEntry<"blog">["data"] & {
  relatedPosts?: CollectionEntry<"blog">[];
};

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  heroAlt,
  tags = [],
  relatedPosts = [],
} = Astro.props;

const currentLocale = getLocaleFromUrl(Astro.url.pathname);
const t = await createTranslator(currentLocale);

const metadata = createMetadata({
  title,
  description,
  pathname: Astro.url.pathname,
  imageUrl: heroImage,
  imageAlt: heroAlt,
});

const articleSchema: WithContext<Article> = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: title,
  description: description,
  url: metadata.canonical as string,
  image: metadata.openGraph?.basic?.image,
  datePublished: pubDate.toISOString(),
  dateModified: updatedDate?.toISOString() || pubDate.toISOString(),
  author: {
    "@type": "Organization",
    name: env.SITE_NAME,
    url: env.SITE_BASE_URL,
  },
};
---

<Layout {...metadata} jsonLd={articleSchema}>
  <div class="container mx-auto px-4 py-12">
    <article class="mx-auto max-w-3xl">
      <div class="mb-8 text-center">
        {
          heroImage && (
            <img
              width={1020}
              height={510}
              src={heroImage}
              alt={heroAlt || title}
              class="mb-8 w-full rounded-xl object-cover"
              loading="eager"
              decoding="async"
              fetchpriority="high"
            />
          )
        }
        <div class="mb-4 text-gray-400">
          <time datetime={pubDate.toISOString()}>
            {
              pubDate.toLocaleDateString(currentLocale, {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            }
          </time>
          {
            updatedDate && (
              <div class="italic">
                Last updated on{" "}
                {updatedDate.toLocaleDateString(currentLocale, {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })}
              </div>
            )
          }
        </div>
        <h1 class="mb-4 text-4xl font-bold text-white md:text-5xl">{title}</h1>
        <hr class="my-4 border-white/10" />
      </div>
      <div class="prose prose-invert mx-auto max-w-none">
        <slot />
      </div>
    </article>

    <div class="mx-auto mt-16 max-w-3xl">
      {
        tags.length > 0 && (
          <div class="flex flex-wrap gap-2">
            {tags.map((tag: string) => (
              <Tag>
                <a
                  href={getLocalizedPath(currentLocale, `/blog/tags/${tag}`)}
                  class="hover:text-primary transition-colors"
                >
                  {t(`blog.tags.${tag}`) || tag}
                </a>
              </Tag>
            ))}
          </div>
        )
      }
    </div>

    {
      relatedPosts.length > 0 && (
        <div class="mt-16 border-t border-white/10 pt-16">
          <h2 class="mb-8 text-2xl font-bold text-white">
            {t("blog.related_posts")}
          </h2>
          <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {relatedPosts.map((relatedPost) => (
              <Card
                title={relatedPost.data.title}
                description={relatedPost.data.description}
                pubDate={relatedPost.data.pubDate}
                href={getLocalizedPath(
                  currentLocale,
                  `/blog/${relatedPost.id.split("/").slice(1).join("/")}`,
                )}
                tags={relatedPost.data.tags}
                heroImage={relatedPost.data.heroImage}
                heroAlt={relatedPost.data.heroAlt}
                featured={relatedPost.data.featured}
              />
            ))}
          </div>
        </div>
      )
    }
  </div>
</Layout>

<style is:global>
  /* Basic typography for blog posts since we might not have @tailwindcss/typography */
  .prose h1,
  .prose h2,
  .prose h3,
  .prose h4 {
    color: var(--color-text-title-primary);
    margin-top: 2em;
    margin-bottom: 1em;
    font-weight: 700;
  }
  .prose h1 {
    font-size: 2.25em;
  }
  .prose h2 {
    font-size: 1.875em;
  }
  .prose h3 {
    font-size: 1.5em;
  }

  .prose p {
    margin-bottom: 1.25em;
    line-height: 1.75;
    color: var(--color-text-content-primary);
  }

  .prose ul {
    list-style-type: disc;
    padding-left: 1.5em;
    margin-bottom: 1.25em;
  }

  .prose ol {
    list-style-type: decimal;
    padding-left: 1.5em;
    margin-bottom: 1.25em;
  }

  .prose li {
    margin-bottom: 0.5em;
  }

  .prose a {
    color: var(--color-primary, #3b82f6);
    text-decoration: underline;
  }

  .prose blockquote {
    border-left: 4px solid var(--color-primary, #3b82f6);
    padding-left: 1em;
    font-style: italic;
    margin-bottom: 1.25em;
  }

  .prose code {
    background-color: rgba(255, 255, 255, 0.1);
    padding: 0.2em 0.4em;
    border-radius: 0.25em;
    font-family: monospace;
  }

  .prose pre {
    background-color: #1a1a1a;
    padding: 1em;
    border-radius: 0.5em;
    overflow-x: auto;
    margin-bottom: 1.25em;
  }

  .prose pre code {
    background-color: transparent;
    padding: 0;
  }
</style>
